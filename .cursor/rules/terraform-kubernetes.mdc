---
description: Terraform and Kubernetes YAML conventions for kani-k8s
globs: terraform/**/*.tf,terraform/**/yamls/*.yaml
alwaysApply: false
---

# Terraform & Kubernetes YAML Conventions

Follow these patterns when editing Terraform or Helm values YAML in this repo. All comments must be in **English**.

---

## File layout

- **Root**: `terraform/do/` – module calls, root variables. Variables are split by domain: `kubernetes_variables.tf`, `domain_variables.tf`, `authentication_variables.tf`, etc.
- **Module**: `terraform/do/modules/kubernetes/` – DOKS cluster, Helm releases, DNS, secrets.
- **Global variables**: Use `global_variables_*.tf` pattern for shared variables used across multiple components:
  - `global_variables_resources.tf` → resource presets configuration
  - `global_variables_mount.tf` → encrypted secrets and GCP service account variables
  - `global_variables_kubernetes.tf` → Kubernetes cluster and node pool variables
  - `global_variables_gcp.tf` → GCP project ID variables
- **Per-component**:
  - One `*_variables.tf` → all variables of that component
  - One or more:
    - `*_locals.tf` → all locals (computed config)
    - `*_resources.tf` or `*_resources_*.tf` → pure Terraform resources (namespace, secret, ingress…)
      - Use `*_resources_*.tf` pattern to split resources by domain (e.g., `jenkins_resources_rbac.tf`, `jenkins_resources_init_groovy.tf`)
    - `*_helm.tf` → `helm_release`
- **YAML**: `terraform/do/modules/kubernetes/yamls/` – Helm values used by `templatefile()`.
  - Names match the chart (e.g. `jenkins.yaml`, `argo-cd.yaml`)
  - Do **not** add `_`-prefixed files here; use `yamls/legacy/` for full/default values reference (e.g. `_jenkins.yaml`)

---

## Comments (English only)

- **Use `//` only** for Terraform comments. Do not use `#` except when commenting out an entire block of code.
- **Block section**: Use a double-line banner with `//` and `=====` for main resource blocks (variables, locals, resources, helm releases):

```hcl
// =========================
// Argo CD controller (replica count + resources)
// =========================
// Argo CD is a declarative GitOps continuous delivery tool for Kubernetes.
// This section configures the controller component with replica count and resource limits.
```

- **Variable comments**: Add a single-line comment above each variable explaining its purpose:

```hcl
// Whether to install cert-manager Custom Resource Definitions (CRDs) during Helm chart installation
variable "cert_manager_install_crds" {
  type        = bool
  description = "Install cert-manager CRDs"
  default     = true
}

// Number of replicas for the cert-manager controller pod
variable "cert_manager_controller_replica_count" {
  type        = number
  description = "Number of cert-manager controller replicas"
  default     = 1
}
```

- **Locals structure**: Use a single `locals` block per component. All computed values for a component should be grouped within a single object named after the component. Include presets, resource values, instances, and other configurations as nested objects:

```hcl
locals {
  external_secrets = {
    presets = {
      external_secrets  = "16"
      webhook           = "16"
      cert_controller   = "16"
    }
    external_secrets = {
      request_cpu = coalesce(
        var.external_secrets_request_cpu,
        try(var.resources_config[local.external_secrets.presets.external_secrets].requests.cpu, "100m")
      )
      // ... more resource values
    }
    webhook = {
      request_cpu = coalesce(...)
      // ... more resource values
    }
    instances = {
      app = {
        name               = "app"
        target_secret_name = "app"
        // ... instance configuration
      }
    }
    gcp_cluster_secret_store = {
      name = "gcp-secret-store"
    }
  }
}
```

All locals for a component must be consolidated into one `locals` block in the `*_locals.tf` file. Do not create multiple separate `locals` blocks for the same component.

- **Templatefile comments**: Use simple inline comments (`//`) for grouping within `templatefile()` blocks, not full comment blocks:

```hcl
templatefile("${path.module}/yamls/cert-manager.yaml", {
  // Installation and replica counts
  install_crds              = var.cert_manager_install_crds
  controller_replica_count = var.cert_manager_controller_replica_count
  
  // Core component resources
  cert_manager_request_cpu = local.cert_manager.cert_manager.request_cpu
})
```