---
description: Terraform and Kubernetes YAML conventions for kani-k8s
globs: terraform/**/*.tf,terraform/**/yamls/*.yaml
alwaysApply: false
---

# Terraform & Kubernetes YAML Conventions

Follow these patterns when editing Terraform or Helm values YAML in this repo. All comments must be in **English**.

---

## File layout

- **Root**: `terraform/do/` – module calls, root variables. Variables are split by domain: `kubernetes_variables.tf`, `domain_variables.tf`, `authentication_variables.tf`, etc.
- **Module**: `terraform/do/modules/kubernetes/` – DOKS cluster, Helm releases, DNS, secrets.
- **Per-component**: One `*_variables.tf` and one or more `*.tf` (e.g. `jenkins.tf`, `jenkins_variables.tf`). Keep variables for a component in its `*_variables.tf`.
- **YAML**: `terraform/do/modules/kubernetes/yamls/` – Helm values used by `templatefile()`. Names match the chart (e.g. `jenkins.yaml`, `argo-cd.yaml`). Do **not** add `_`-prefixed files here; use `yamls/legacy/` for full/default values reference (e.g. `_jenkins.yaml`).

---

## Comments (English only)

- **Use `//` only** for Terraform comments. Do not use `#` except when commenting out an entire block of code.
- **Block section**: Use a double-line banner with `//` and `=====`:
  ```hcl
  // =========================
  // Section title (e.g. "Jenkins Helm release")
  // =========================
  ```
- **Inline**: One line above or at end of line with `//`. Explain *what* or *why*, not the obvious.
  ```hcl
  // Ensure the Kubernetes cluster exists before creating the namespace
  depends_on = [digitalocean_kubernetes_cluster.kubernetes]
  ```
- **Module inputs**: Group related inputs and add a short `//` comment for non-obvious ones (e.g. "Admin password for Argo CD (bcrypt-hashed)").

---

## Naming

- **Variables**: `snake_case`. Prefix by component when in a shared file (e.g. `argo_cd_redis_password`, `jenkins_persistence_size`, `kafka_broker_replica_count`).
- **Resources**: `resource "type" "short_name"` – e.g. `helm_release.jenkins`, `kubernetes_namespace.jenkins`, `data.kubernetes_service.jenkins_server`.
- **Locals**: Short names for IDs (e.g. `jenkins_name`, `jenkins_server_service_name`). Use nested objects for computed values (e.g. `local.jenkins.jenkins.request_cpu`).
- **YAML placeholders**: Same as Terraform keys passed to `templatefile()` – `snake_case` (e.g. `${replica_count}`, `${master_persistence_size}`).

---

## Variables and locals

- Prefer `type`, `description`, and `default` (or `nullable = true` + `default = null` for optional overrides).
- Mark secrets with `sensitive = true`.
- **Resource presets**: Use a shared `resources_config` map (see `resources_variables.tf`) and `coalesce(var.x, try(var.resources_config[local.presets.key].requests.cpu, "fallback"))` so component vars override preset by key (e.g. "16", "32").

---

## Helm values and templatefile

- **Values YAML** (e.g. `jenkins.yaml`, `redis.yaml`): Only the keys that are overridden; all values come from Terraform via `templatefile("${path.module}/yamls/...yaml", { ... })`. Use placeholders `${var_name}` for every value that is not fixed.
- **Sections in YAML**: Add section comments with `## =========================` and `## Section title` (English). Group related keys (e.g. "Authentication", "Persistence", "Controller resources").
- **Replica counts / persistence**: Prefer Terraform variables (e.g. `replica_count`, `persistence_size`, `broker_replica_count`) and pass them in the corresponding `templatefile()`; avoid hardcoding in YAML.
- **Images**: Use `bitnamilegacy/*` for Bitnami-based charts; set `image.registry` and `image.repository` (and component-specific image blocks where needed) in the values YAML, wired from TF if needed.

---

## Resource ordering and depends_on

- **Preferred order in a component `.tf` file**: (1) Namespace, (2) Locals (names/IDs), (3) Main resource (e.g. `helm_release`), (4) Data sources that depend on it, (5) Locals that use data (e.g. service host/port), (6) Additional resources (Deployment, Service, Secret, Ingress) in dependency order, (7) `depends_on` where the provider cannot infer it.
- **Preferred order in a `*_variables.tf` file**: Group variables with section comments (e.g. "Authentication", "Replica count", "Persistence", "Resources", "Init container"). Put replica/persistence/size vars before resource request/limit vars.
- Set `depends_on` explicitly where the provider cannot infer it (e.g. namespace, or another module resource).

---

## Examples

**Variable (in `*_variables.tf`):**
```hcl
variable "jenkins_persistence_size" {
  type        = string
  description = "Persistent volume size for Jenkins home data"
  default     = "8Gi"
}
```

**Templatefile (in `jenkins.tf`):**
```hcl
values = [
  templatefile("${path.module}/yamls/jenkins.yaml", {
    // =========================
    // Persistence
    // =========================
    persistence_size = var.jenkins_persistence_size
    // ...
  })
]
```

**YAML section (in `jenkins.yaml`):**
```yaml
## =========================
## Persistence
## =========================
persistence:
  size: ${persistence_size}
```
