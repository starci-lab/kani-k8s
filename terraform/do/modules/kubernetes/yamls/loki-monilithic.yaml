## =========================
## Loki Monolithic (Grafana chart, SingleBinary)
## =========================
## Template variables: replication_factor, request_cpu, request_memory, limit_cpu, limit_memory, persistence_size, node_pool_label
## Values are injected via Terraform templatefile() in loki_monolithic_helm.tf
##
## =========================
## Loki configuration
## =========================
## Common config, schema, limits and ruler for single-binary mode.
## See: https://grafana.com/docs/loki/latest/configuration/
loki:
  commonConfig:
    replication_factor: ${replication_factor}
  storage:
    type: filesystem
    bucketNames:
      chunks: chunks
      ruler: ruler
      admin: admin
  auth_enabled: false

  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  pattern_ingester:
    enabled: true

  limits_config:
    allow_structured_metadata: true
    volume_enabled: true

  ruler:
    enable_api: true

## =========================
## MinIO (object storage)
## =========================
## Disabled when using external S3 or filesystem; set enabled: true for local object storage.
minio:
  enabled: false

## =========================
## Deployment mode
## =========================
## SingleBinary runs all Loki components in one process (one or few pods).
deploymentMode: SingleBinary

## =========================
## Single-binary deployment
## =========================
## Replicas, resources, persistence and node scheduling for the Loki single-binary pod(s).
singleBinary:
  replicas: ${replication_factor}
  resources:
    requests:
      cpu: ${request_cpu}
      memory: ${request_memory}
    limits:
      cpu: ${limit_cpu}
      memory: ${limit_memory}
  persistence:
    size: ${persistence_size}
  nodeSelector:
    "doks.digitalocean.com/node-pool": ${node_pool_label}

## =========================
## Other deployment modes (disabled)
## =========================
## Zero out replica counts so only SingleBinary is used.
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0

ingester:
  replicas: 0
querier:
  replicas: 0
queryFrontend:
  replicas: 0
queryScheduler:
  replicas: 0
distributor:
  replicas: 0
compactor:
  replicas: 0
indexGateway:
  replicas: 0
bloomCompactor:
  replicas: 0
bloomGateway:
  replicas: 0

## =========================
## Caches and canary
## =========================
resultsCache:
  enabled: false

chunksCache:
  enabled: false

## =========================
## Loki Canary
## =========================
lokiCanary:
  replicas: ${canary_replicas}
  enabled: true
  resources:
    requests:
      cpu: ${canary_request_cpu}
      memory: ${canary_request_memory}
    limits:
      cpu: ${canary_limit_cpu}
      memory: ${canary_limit_memory}
  nodeSelector:
    "doks.digitalocean.com/node-pool": ${node_pool_label}
    
## =========================
## Loki Gateway
## =========================
gateway:
  enabled: true
  replicas: ${gateway_replicas}
  nodeSelector:
    "doks.digitalocean.com/node-pool": ${node_pool_label}
  resources:
    requests:
      cpu: ${gateway_request_cpu}
      memory: ${gateway_request_memory}
    limits:
      cpu: ${gateway_limit_cpu}
      memory: ${gateway_limit_memory}