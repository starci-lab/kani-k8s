# Number of pod replicas to run for kani-interface
# Should be increased for high availability or high traffic
replicaCount: ${replica_count}

# =========================================================
# NON-SENSITIVE ENVIRONMENT VARIABLES (ConfigMap)
# These variables are visible in plain text inside the cluster
# =========================================================
envVarsCM:
  # Application runtime environment
  NODE_ENV: production

  # Application listening port (must match containerPorts & service ports)
  KANI_OBSERVER_PORT: "${port}"

  # ------------------------
  # PRIMARY MONGODB SETTINGS
  # ------------------------
  PRIMARY_MONGO_DB_HOST: "${primary_mongodb_host}"      # MongoDB hostname / service name
  PRIMARY_MONGO_DB_PORT: "${primary_mongodb_port}"      # MongoDB port (default: 27017)
  PRIMARY_MONGO_DB_USERNAME: "${primary_mongodb_username}"
  PRIMARY_MONGO_DB_NAME: "${primary_mongodb_database}"

  # ------------------------
  # KAFKA CONFIGURATION
  # ------------------------
  KAFKA_BROKER_HOST: "${kafka_broker_host}"              # Kafka bootstrap server host
  KAFKA_BROKER_PORT: "${kafka_broker_port}"              # Kafka broker port
  KAFKA_SASL_ENABLED: "${kafka_sasl_enabled}"            # Enable SASL authentication (true/false)
  KAFKA_SASL_USERNAME: "${kafka_sasl_username}"

  # ------------------------
  # REDIS – CACHE LAYER
  # ------------------------
  REDIS_CACHE_HOST: "${redis_cache_host}"
  REDIS_CACHE_PORT: "${redis_cache_port}"
  REDIS_CACHE_USE_CLUSTER: "${redis_cache_use_cluster}"  # true if Redis Cluster mode is enabled

  # ------------------------
  # REDIS – ADAPTER
  # ------------------------
  REDIS_ADAPTER_HOST: "${redis_adapter_host}"
  REDIS_ADAPTER_PORT: "${redis_adapter_port}"
  REDIS_ADAPTER_USE_CLUSTER: "${redis_adapter_use_cluster}"

  # ------------------------
  # REDIS – BULLMQ (BACKGROUND JOBS)
  # ------------------------
  REDIS_BULLMQ_HOST: "${redis_bullmq_host}"
  REDIS_BULLMQ_PORT: "${redis_bullmq_port}"
  REDIS_BULLMQ_USE_CLUSTER: "${redis_bullmq_use_cluster}"

  # ------------------------
  # REDIS – THROTTLER / RATE LIMITING
  # ------------------------
  REDIS_THROTTLER_HOST: "${redis_throttler_host}"
  REDIS_THROTTLER_PORT: "${redis_throttler_port}"
  REDIS_THROTTLER_USE_CLUSTER: "${redis_throttler_use_cluster}"

  # ------------------------
  # FILE-BASED SECRETS (MOUNT PATHS)
  # These paths point to mounted Kubernetes Secrets
  # Application reads secrets from files instead of env vars
  # ------------------------
  GCP_CRYPTO_KEY_ED_SA_MOUNT_PATH: "${gcp_crypto_key_ed_sa_mount_path}/data"
  AES_MOUNT_PATH: "${aes_mount_path}/data"
  JWT_SECRET_MOUNT_PATH: "${jwt_secret_mount_path}/data"
  SMTP_MOUNT_PATH: "${stmp_mount_path}/data"
  API_KEYS_MOUNT_PATH: "${api_keys_mount_path}/data"
  RPCS_MOUNT_PATH: "${rpcs_mount_path}/data"
  GOOGLE_DRIVE_UD_SA_MOUNT_PATH: "${google_drive_ud_sa_mount_path}/data"
# =========================================================
# SENSITIVE ENVIRONMENT VARIABLES (Kubernetes Secrets)
# These values are base64-encoded and not visible in plain text
# =========================================================
envVarsSecret:
  PRIMARY_MONGO_DB_PASSWORD: "${primary_mongodb_password}"
  KAFKA_SASL_PASSWORD: "${kafka_sasl_password}"

  REDIS_CACHE_PASSWORD: "${redis_cache_password}"
  REDIS_ADAPTER_PASSWORD: "${redis_adapter_password}"
  REDIS_BULLMQ_PASSWORD: "${redis_bullmq_password}"
  REDIS_THROTTLER_PASSWORD: "${redis_throttler_password}"

  # Cryptography & security secrets
  GCP_KMS_KEY_NAME: "${gcp_kms_key_name}"
  JWT_SALT: "${jwt_salt}"
  AES_CBC_SALT: "${aes_cbc_salt}"

# =========================================================
# CONTAINER PORTS
# Ports exposed by the application container
# =========================================================
containerPorts:
  app:
    port: ${port}        # Main HTTP application port
  healthCheck:
    port: ${port}        # Health endpoint port (usually same as app)

# =========================================================
# SERVICE CONFIGURATION
# Exposes container ports inside the Kubernetes cluster
# =========================================================
service:
  ports:
    app:
      port: ${port}      # Service port for application traffic
    healthCheck:
      port: ${port}      # Service port for health probes

# =========================================================
# CONTAINER IMAGE SETTINGS
# =========================================================
image:
  registry: docker.io
  repository: ${kani_observer_image_repository}
  tag: ${kani_observer_image_tag}            # Image tag (avoid 'latest' in production if possible)
  digest: ""             # Optional image digest (overrides tag if set)
  pullPolicy: Always     # Always pull image on pod start
  pullSecrets: []        # Add secrets here if using private registry

# =========================================================
# NODE SCHEDULING
# Restrict pods to specific node pool
# =========================================================
nodeSelector:
  "doks.digitalocean.com/node-pool": ${node_pool_label}

# =========================================================
# RESOURCE REQUESTS & LIMITS
# Controls CPU & memory usage
# =========================================================
resources:
  requests:
    cpu: ${request_cpu}        # Guaranteed CPU
    memory: ${request_memory}  # Guaranteed memory
  limits:
    cpu: ${limit_cpu}          # Max CPU allowed
    memory: ${limit_memory}    # Max memory allowed

# =========================================================
# EXTRA VOLUMES (Kubernetes Secrets)
# =========================================================
extraVolumes:
  - name: aes
    secret:
      secretName: aes
  - name: crypto-key-ed-sa
    secret:
      secretName: crypto-key-ed-sa
  - name: jwt-secret
    secret:
      secretName: jwt-secret
  - name: smtp
    secret:
      secretName: smtp
  - name: api-keys
    secret:
      secretName: api-keys
  - name: rpcs
    secret:
      secretName: rpcs
  - name: google-drive-ud-sa
    secret:
      secretName: google-drive-ud-sa

# =========================================================
# VOLUME MOUNTS INSIDE CONTAINER
# =========================================================
extraVolumeMounts:
  - name: aes
    mountPath: "${aes_mount_path}"
    readOnly: true
  - name: crypto-key-ed-sa
    mountPath: "${gcp_crypto_key_ed_sa_mount_path}"
    readOnly: true
  - name: jwt-secret
    mountPath: "${jwt_secret_mount_path}"
    readOnly: true
  - name: smtp
    mountPath: "${stmp_mount_path}"
    readOnly: true
  - name: api-keys
    mountPath: "${api_keys_mount_path}"
    readOnly: true
  - name: rpcs
    mountPath: "${rpcs_mount_path}"
    readOnly: true
  - name: google-drive-ud-sa
    mountPath: "${google_drive_ud_sa_mount_path}"
    readOnly: true

# =========================================================
# HEALTH PROBES
# Used by Kubernetes to manage pod lifecycle
# =========================================================
livenessProbe:
  path: "${liveness_probe_path}"     # Endpoint to check if app is alive
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  path: "${readiness_probe_path}"    # Endpoint to check if app is ready to serve traffic
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

startupProbe:
  path: "${startup_probe_path}"      # Endpoint used during application startup
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1
