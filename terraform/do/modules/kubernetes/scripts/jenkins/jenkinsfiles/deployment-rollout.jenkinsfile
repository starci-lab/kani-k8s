pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-agent
  containers:
    - name: kubectl
      image: bitnami/kubectl
      command:
        - sleep
        - infinity
      securityContext:
        runAsUser: 1001
"""
      defaultContainer 'kubectl'
    }
  }
  environment {
    DEPLOYMENT = "${deployment_name}"
    NAMESPACE  = "${namespace_name}"
  }
  stages {
    stage('Rollout Deployment') {
      steps {
        sh '''
          set -e
          echo "=================================="
          echo "Rollout Restart Deployment"
          echo "Deployment : $${DEPLOYMENT}"
          echo "Namespace  : $${NAMESPACE}"
          echo "=================================="
          kubectl rollout restart deployment/$${DEPLOYMENT} -n $${NAMESPACE}
          echo "Waiting for Deployment Rollout to finish..."
          kubectl rollout status deployment/$${DEPLOYMENT} \
            -n $${NAMESPACE} \
            --timeout=300s
          echo "Deployment Rollout Completed Successfully"
        '''
      }
    }
  }
}